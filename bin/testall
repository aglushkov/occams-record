#!/usr/bin/env bash

#
# Run every combination:
#   bin/testall
#
# Run just the matching combinations:
#   bin/testall ruby-3.0
#

set -euo pipefail

cd $(dirname $0)/../
source bin/lib.sh

[[ $# -gt 0 ]] && filter=$@ || filter=()

function run {
  if [[ ${#filter} -eq 0 ]] || in_array $1 ${filter[@]} || in_array $2 ${filter[@]} || in_array $3 ${filter[@]}; then
    cmd="bin/test  $1  $2  $3"
    announce "$cmd"
    sleep 1
    $cmd
  fi
}

# flatten matrix
matrix=()
while read ruby_version ar_version dbs; do
  for db in $dbs; do
    matrix+=("$ruby_version $ar_version $db")
  done
done < <(awk '/^ *[^#]/' test/matrix)

# run each row in the matrix
for row in "${matrix[@]}"; do
  read ruby_version ar_version db <<< "$row"
  run $ruby_version $ar_version $db
done

docker compose stop
nyancat
